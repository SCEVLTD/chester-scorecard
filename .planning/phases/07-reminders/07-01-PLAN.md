---
phase: 07-reminders
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/send-reminders/index.ts
  - supabase/migrations/20260202_add_reminder_infrastructure.sql
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for reminder notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify velocitygrowth.co.uk domain"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Database function returns businesses without submitted data for a given month"
    - "Edge Function sends email via Resend API when invoked"
    - "pg_cron job scheduled to trigger Edge Function daily at 9am UTC"
  artifacts:
    - path: "supabase/functions/send-reminders/index.ts"
      provides: "Edge Function for sending reminder emails"
      min_lines: 80
    - path: "supabase/migrations/20260202_add_reminder_infrastructure.sql"
      provides: "Database function and cron job setup"
      contains: "get_pending_submissions"
  key_links:
    - from: "pg_cron job"
      to: "send-reminders Edge Function"
      via: "pg_net HTTP POST"
      pattern: "net.http_post"
    - from: "send-reminders Edge Function"
      to: "Resend API"
      via: "fetch to api.resend.com"
      pattern: "api.resend.com/emails"
    - from: "get_pending_submissions function"
      to: "data_requests table"
      via: "LEFT JOIN to check status"
      pattern: "data_requests.*status.*submitted"
---

<objective>
Create the reminder email infrastructure: database function to find pending submissions and Edge Function to send emails via Resend.

Purpose: Enable automated daily email reminders to businesses that haven't submitted monthly data.
Output: Working Edge Function that can be triggered manually or via pg_cron to send reminder emails.
</objective>

<execution_context>
@C:\Users\conta\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\conta\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-reminders/07-RESEARCH.md

# Existing Edge Function pattern
@supabase/functions/generate-meeting-summary/index.ts

# Database schema context
@supabase/migrations/20260202_add_auth_schema.sql
@supabase/migrations/20260127_add_data_requests.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send-reminders Edge Function and database function</name>
  <files>
    supabase/functions/send-reminders/index.ts
    supabase/migrations/20260202_add_reminder_infrastructure.sql
  </files>
  <action>
Create the Edge Function following the pattern from generate-meeting-summary:

**Edge Function (supabase/functions/send-reminders/index.ts):**
- Import createClient from esm.sh/@supabase/supabase-js@2
- Read RESEND_API_KEY, SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY from Deno.env
- Handle CORS preflight (OPTIONS returns 'ok')
- On POST:
  1. Check RESEND_API_KEY exists, throw error if not
  2. Create Supabase client with service role key (bypasses RLS)
  3. Calculate current month as YYYY-MM format
  4. Call database function get_pending_submissions(target_month)
  5. For each pending business, call sendReminderEmail()
  6. Return JSON with { sent: count, results: array }
- sendReminderEmail function:
  - Build submission URL: https://chester-scorecard.vercel.app/company/{business_id}/submit
  - POST to https://api.resend.com/emails with:
    - from: 'Chester Business Group <noreply@velocitygrowth.co.uk>'
    - to: user_email
    - subject: 'Monthly Data Submission Reminder - {month}'
    - html: Simple HTML with greeting, reminder text, CTA button linking to submission URL
  - Return { status, ok } from Resend response

**Database Migration (supabase/migrations/20260202_add_reminder_infrastructure.sql):**
- Create function get_pending_submissions(target_month text) RETURNS TABLE:
  - business_id uuid
  - business_name text
  - user_email text
  - month text
- Function body:
  - SELECT DISTINCT ON (b.id) from businesses b
  - JOIN profiles p ON p.business_id = b.id
  - JOIN auth.users u ON u.id = p.id
  - LEFT JOIN data_requests dr ON dr.business_id = b.id AND dr.month = target_month AND dr.status = 'submitted'
  - WHERE dr.id IS NULL (no submitted request for this month)
- Use SECURITY DEFINER to allow Edge Function to query across auth.users
- Grant EXECUTE on function to service_role

Do NOT add the pg_cron job yet - that requires Vault secrets to be set up first (Task 2).
  </action>
  <verify>
    - File exists: supabase/functions/send-reminders/index.ts
    - File exists: supabase/migrations/20260202_add_reminder_infrastructure.sql
    - Migration contains CREATE OR REPLACE FUNCTION get_pending_submissions
    - Edge Function contains RESEND_API_KEY check
    - Edge Function contains fetch to api.resend.com/emails
  </verify>
  <done>
    - Edge Function created with Resend integration
    - Database function created for finding pending submissions
    - Both ready for deployment
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pg_cron job setup SQL (commented with setup instructions)</name>
  <files>
    supabase/migrations/20260202_add_reminder_infrastructure.sql
  </files>
  <action>
Add to the migration file a commented section for pg_cron setup that requires manual execution after Vault secrets are configured:

**Add to end of migration file:**
```sql
-- =============================================================================
-- MANUAL SETUP REQUIRED: pg_cron job for daily reminders
-- =============================================================================
-- Run these commands manually in Supabase SQL Editor after:
-- 1. Setting RESEND_API_KEY in Edge Function secrets
-- 2. Storing project URL and anon key in Supabase Vault
--
-- Step 1: Store secrets in Vault (run once)
-- SELECT vault.create_secret('https://YOUR_PROJECT_REF.supabase.co', 'project_url');
-- SELECT vault.create_secret('YOUR_SUPABASE_ANON_KEY', 'anon_key');
--
-- Step 2: Schedule the cron job (run once)
-- SELECT cron.schedule(
--   'send-reminder-emails',
--   '0 9 * * *',  -- 9:00 AM UTC daily
--   $$
--   SELECT net.http_post(
--     url := (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url')
--            || '/functions/v1/send-reminders',
--     headers := jsonb_build_object(
--       'Content-Type', 'application/json',
--       'Authorization', 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'anon_key')
--     ),
--     body := jsonb_build_object('trigger', 'scheduled')
--   ) AS request_id;
--   $$
-- );
--
-- To verify job is scheduled: SELECT * FROM cron.job;
-- To see job history: SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 10;
-- =============================================================================
```

This provides clear instructions for manual cron setup while keeping the main migration safe to run automatically.
  </action>
  <verify>
    - Migration file contains commented pg_cron setup instructions
    - Instructions include vault.create_secret commands
    - Instructions include cron.schedule command with correct URL pattern
    - Verification queries included (cron.job, cron.job_run_details)
  </verify>
  <done>
    - pg_cron setup instructions documented in migration
    - Clear step-by-step process for admin to follow
    - No auto-execution of cron (requires Vault secrets)
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - TypeScript compiles without errors
2. Migration file syntax valid (no SQL errors on parse)
3. Edge Function follows existing pattern (corsHeaders, Deno.serve, error handling)
4. Database function uses SECURITY DEFINER for cross-schema access
</verification>

<success_criteria>
1. Edge Function can be deployed with `npx supabase functions deploy send-reminders`
2. Migration can be applied with `supabase db push`
3. get_pending_submissions function returns correct businesses when tested
4. Edge Function sends test email when invoked manually (after RESEND_API_KEY set)
</success_criteria>

<output>
After completion, create `.planning/phases/07-reminders/07-01-SUMMARY.md`
</output>

---
phase: 03-unified-form
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/pages/unified-submit.tsx
  - src/hooks/use-unified-submission.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Company user can open unified form at /company/:businessId/submit"
    - "Form shows month selector at top"
    - "Form shows financial fields with EBITDA auto-calculation"
    - "Form shows Lead KPI fields (outbound calls, first orders)"
    - "Form shows 6 qualitative scoring radio groups"
    - "Form shows commentary textareas"
    - "Submitting form saves all data to company_submissions"
    - "Form is completable in under 10 minutes"
  artifacts:
    - path: "src/pages/unified-submit.tsx"
      provides: "Unified submission page component"
      min_lines: 200
    - path: "src/hooks/use-unified-submission.ts"
      provides: "Mutation hook for unified submissions"
      exports: ["useCreateUnifiedSubmission", "useUnifiedSubmission"]
    - path: "src/App.tsx"
      provides: "Route registration"
      contains: "/company/:businessId/submit"
  key_links:
    - from: "src/pages/unified-submit.tsx"
      to: "src/schemas/unified-submission.ts"
      via: "zodResolver import"
      pattern: "unifiedSubmissionSchema"
    - from: "src/pages/unified-submit.tsx"
      to: "src/hooks/use-unified-submission.ts"
      via: "mutation hook import"
      pattern: "useCreateUnifiedSubmission"
    - from: "src/App.tsx"
      to: "src/pages/unified-submit.tsx"
      via: "Route component"
      pattern: "UnifiedSubmitPage"
---

<objective>
Create the unified submission form page and hook for authenticated company users.

Purpose: This is the core Phase 3 deliverable - a single page where companies enter all their monthly data (financials, lead KPIs, qualitative self-assessment, commentary). Replaces the token-based magic link flow with authenticated submission.

Output: Working form at /company/:businessId/submit that saves to company_submissions table.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-unified-form/03-RESEARCH.md
@.planning/phases/03-unified-form/03-01-SUMMARY.md

# Key source files for patterns
@src/pages/company-submit.tsx
@src/pages/scorecard.tsx
@src/schemas/unified-submission.ts
@src/hooks/use-company-submissions.ts
@src/contexts/auth-context.tsx
@src/lib/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified submission hook</name>
  <files>src/hooks/use-unified-submission.ts</files>
  <action>
Create a new hook file with two exports:

1. `useCreateUnifiedSubmission()` - mutation to create/upsert unified submission
2. `useUnifiedSubmission(businessId, month)` - query to fetch existing submission for edit

The mutation should:
- Accept UnifiedSubmissionData + businessId
- Create a data_request record if none exists for this business+month (or find existing)
- Upsert to company_submissions with all fields including qualitative
- Calculate total_score using calculateTotalScore from scoring.ts
- Return the created/updated submission

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import { calculateTotalScore } from '@/lib/scoring'
import type { CompanySubmission } from '@/types/database.types'
import type { UnifiedSubmissionData } from '@/schemas/unified-submission'

export function useCreateUnifiedSubmission() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({
      businessId,
      data,
    }: {
      businessId: string
      data: UnifiedSubmissionData
    }) => {
      // 1. Find or create data_request for this business+month
      let { data: existingRequest } = await supabase
        .from('data_requests')
        .select('id')
        .eq('business_id', businessId)
        .eq('month', data.month)
        .single()

      let dataRequestId: string

      if (existingRequest) {
        dataRequestId = existingRequest.id
      } else {
        // Create new data_request
        const { data: newRequest, error: createError } = await supabase
          .from('data_requests')
          .insert({
            business_id: businessId,
            month: data.month,
            token: crypto.randomUUID(), // Not used for auth flow but required
            status: 'submitted',
            expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days
          })
          .select()
          .single()

        if (createError) throw createError
        dataRequestId = newRequest.id
      }

      // 2. Calculate score from qualitative inputs
      const score = calculateTotalScore({
        leadership: data.leadership,
        marketDemand: data.marketDemand,
        marketing: data.marketing,
        productStrength: data.productStrength,
        supplierStrength: data.supplierStrength,
        salesExecution: data.salesExecution,
        // Financial variances would need calculation - for now just qualitative
      })

      // 3. Upsert submission
      const { data: result, error } = await supabase
        .from('company_submissions')
        .upsert({
          data_request_id: dataRequestId,
          // Financial
          revenue_actual: data.revenueActual,
          revenue_target: data.revenueTarget,
          gross_profit_actual: data.grossProfitActual,
          gross_profit_target: data.grossProfitTarget,
          overheads_actual: data.overheadsActual,
          overheads_budget: data.overheadsBudget,
          net_profit_actual: data.netProfitActual,
          net_profit_target: data.netProfitTarget,
          net_profit_override: data.netProfitOverride || false,
          total_wages: data.totalWages,
          productivity_benchmark: data.productivityBenchmark,
          // Lead KPIs
          outbound_calls: data.outboundCalls ?? null,
          first_orders: data.firstOrders ?? null,
          // Qualitative
          leadership: data.leadership,
          market_demand: data.marketDemand,
          marketing: data.marketing,
          product_strength: data.productStrength,
          supplier_strength: data.supplierStrength,
          sales_execution: data.salesExecution,
          // Commentary
          company_wins: data.companyWins || null,
          company_challenges: data.companyChallenges || null,
          company_biggest_opportunity: data.companyBiggestOpportunity || null,
          company_biggest_risk: data.companyBiggestRisk || null,
        }, { onConflict: 'data_request_id' })
        .select()
        .single()

      if (error) throw error

      // 4. Mark data_request as submitted
      await supabase
        .from('data_requests')
        .update({ status: 'submitted' })
        .eq('id', dataRequestId)

      return result as CompanySubmission
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['unified-submission', variables.businessId] })
    },
  })
}

export function useUnifiedSubmission(businessId: string | undefined, month: string | undefined) {
  return useQuery({
    queryKey: ['unified-submission', businessId, month],
    queryFn: async () => {
      const { data: request } = await supabase
        .from('data_requests')
        .select('id')
        .eq('business_id', businessId!)
        .eq('month', month!)
        .single()

      if (!request) return null

      const { data: submission } = await supabase
        .from('company_submissions')
        .select('*')
        .eq('data_request_id', request.id)
        .single()

      return submission as CompanySubmission | null
    },
    enabled: !!businessId && !!month,
  })
}
```

Handle the case where PGRST116 (no rows) is returned - return null, don't throw.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
The hook exports useCreateUnifiedSubmission and useUnifiedSubmission.
  </verify>
  <done>Unified submission hook ready. Handles data_request creation, upsert to company_submissions with all fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create unified submission page</name>
  <files>src/pages/unified-submit.tsx</files>
  <action>
Create a new page component that combines all form sections.

Structure (follow existing company-submit.tsx patterns):
1. Header with Chester branding (use same pattern as company-submit.tsx lines 207-226)
2. Month selector (from scorecard.tsx lines 84-104, 294-327)
3. Financial section (Revenue, GP, Overheads, EBITDA with auto-calc from company-submit.tsx)
4. Lead KPIs section (simple number inputs for outbound_calls, first_orders)
5. Qualitative scoring (6 radio groups - use Controller pattern from sales-section.tsx)
6. Commentary section (4 textareas from company-submit.tsx lines 466-523)
7. Submit button

Key implementation details:
- Use `useAuth()` to get businessId from JWT claims
- Use `useParams()` to get businessId from URL as backup
- Use `useForm` with `zodResolver(unifiedSubmissionSchema)`
- EBITDA auto-calculation: Same pattern as company-submit.tsx lines 62-73
- Show existing data if editing (useUnifiedSubmission query)
- On submit: call useCreateUnifiedSubmission mutation
- On success: show toast and navigate to /business/:businessId

Import scoring options from src/lib/scoring.ts:
- LEADERSHIP_OPTIONS, MARKET_DEMAND_OPTIONS, MARKETING_OPTIONS
- PRODUCT_OPTIONS, SUPPLIER_OPTIONS, SALES_OPTIONS

Use Card components to group sections. Each section should show its point value in the header (like existing section components).

Page should be completable in under 10 minutes - avoid unnecessary complexity.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
File exists with:
- useAuth() import and usage
- useForm with unifiedSubmissionSchema
- All 6 qualitative radio groups
- EBITDA auto-calculation useEffect
- Month selector
- Submit handler calling mutation
  </verify>
  <done>Unified submit page renders all sections: month, financials, lead KPIs, qualitative scoring, commentary. Form validates and submits.</done>
</task>

<task type="auto">
  <name>Task 3: Add route to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Add a new protected route for the unified submission page.

1. Import the new page:
```typescript
import { UnifiedSubmitPage } from '@/pages/unified-submit'
```

2. Add route after the existing business-scoped routes (around line 78, before the legacy route):
```typescript
<Route path="/company/:businessId/submit">
  {(params) => (
    <ProtectedRoute allowedBusinessId={params.businessId}>
      <UnifiedSubmitPage />
    </ProtectedRoute>
  )}
</Route>
```

This route is protected - only the business owner (or admin) can access it. The ProtectedRoute component checks that the user's businessId matches the URL param.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
Grep App.tsx for "/company/:businessId/submit" - should be present.
Run `npm run dev` and visit /company/{valid-uuid}/submit - should load the form (after login).
  </verify>
  <done>Route /company/:businessId/submit registered and protected. UnifiedSubmitPage renders for authorized users.</done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Log in as a business_user
3. Navigate to /company/{businessId}/submit
4. Verify form shows:
   - Month selector
   - Financial fields (Revenue, GP, Overheads, EBITDA)
   - Lead KPI fields (Outbound Calls, First Orders)
   - 6 qualitative radio groups with points displayed
   - 4 commentary textareas
5. Fill out form and submit
6. Check Supabase: company_submissions should have new record with all fields
7. Check data_requests: should have matching record for business+month
</verification>

<success_criteria>
- /company/:businessId/submit route works for authenticated business users
- Form displays all sections in single scrollable page
- EBITDA auto-calculates from GP - Overheads (with manual override option)
- Qualitative scoring shows all 6 categories with radio options
- Form validates all required fields
- Submission creates record in company_submissions with all data
- Success redirects to business history page
</success_criteria>

<output>
After completion, create `.planning/phases/03-unified-form/03-02-SUMMARY.md`
</output>

---
phase: 03-unified-form
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202_add_unified_submission_columns.sql
  - src/types/database.types.ts
  - src/schemas/unified-submission.ts
autonomous: true

must_haves:
  truths:
    - "Database accepts qualitative scoring fields on company_submissions"
    - "TypeScript types include Lead KPIs (outbound_calls, first_orders)"
    - "TypeScript types include qualitative fields (leadership, market_demand, etc.)"
    - "Validation schema validates all unified form fields"
  artifacts:
    - path: "supabase/migrations/20260202_add_unified_submission_columns.sql"
      provides: "6 qualitative columns added to company_submissions"
      contains: "ADD COLUMN.*leadership"
    - path: "src/types/database.types.ts"
      provides: "Updated CompanySubmission type"
      contains: "outbound_calls.*number"
    - path: "src/schemas/unified-submission.ts"
      provides: "Zod schema for unified submission form"
      exports: ["unifiedSubmissionSchema", "UnifiedSubmissionData"]
  key_links:
    - from: "src/schemas/unified-submission.ts"
      to: "src/types/database.types.ts"
      via: "Type alignment"
      pattern: "CompanySubmission"
---

<objective>
Add database schema and TypeScript types for unified form fields.

Purpose: The unified form needs to store qualitative scoring (leadership, market_demand, marketing, product_strength, supplier_strength, sales_execution) directly in company_submissions. The existing Lead KPI columns (outbound_calls, first_orders) need TypeScript types. This plan creates the data foundation.

Output: Migration file, updated types, validation schema ready for form implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-unified-form/03-RESEARCH.md

# Key source files
@src/types/database.types.ts
@src/schemas/company-submission.ts
@src/lib/scoring.ts
@supabase/migrations/20260201_add_lead_kpis.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for qualitative columns</name>
  <files>supabase/migrations/20260202_add_unified_submission_columns.sql</files>
  <action>
Create a new migration file that adds 6 qualitative scoring columns to the company_submissions table:

```sql
-- Add qualitative scoring columns to company_submissions
-- These allow company users to self-assess their business in the unified form

ALTER TABLE company_submissions
ADD COLUMN IF NOT EXISTS leadership text DEFAULT NULL,
ADD COLUMN IF NOT EXISTS market_demand text DEFAULT NULL,
ADD COLUMN IF NOT EXISTS marketing text DEFAULT NULL,
ADD COLUMN IF NOT EXISTS product_strength text DEFAULT NULL,
ADD COLUMN IF NOT EXISTS supplier_strength text DEFAULT NULL,
ADD COLUMN IF NOT EXISTS sales_execution text DEFAULT NULL;

-- Add comments for documentation
COMMENT ON COLUMN company_submissions.leadership IS 'Leadership alignment: aligned, minor, misaligned, toxic';
COMMENT ON COLUMN company_submissions.market_demand IS 'Market demand: strong, flat, softening, decline';
COMMENT ON COLUMN company_submissions.marketing IS 'Marketing effectiveness: clear, activity, poor, none';
COMMENT ON COLUMN company_submissions.product_strength IS 'Product/service strength: differentiated, adequate, weak, broken';
COMMENT ON COLUMN company_submissions.supplier_strength IS 'Supplier strength: strong, acceptable, weak, damaging';
COMMENT ON COLUMN company_submissions.sales_execution IS 'Sales execution: beating, onTarget, underperforming, none';
```

The column values match the scoring options in src/lib/scoring.ts (LEADERSHIP_OPTIONS, MARKET_DEMAND_OPTIONS, etc.).
  </action>
  <verify>
File exists at supabase/migrations/20260202_add_unified_submission_columns.sql with all 6 ALTER TABLE statements.
  </verify>
  <done>Migration file ready for deployment. Contains leadership, market_demand, marketing, product_strength, supplier_strength, sales_execution columns.</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types for company_submissions</name>
  <files>src/types/database.types.ts</files>
  <action>
Update the company_submissions type definitions in database.types.ts to include:

1. Lead KPI fields (from existing migration, not yet in types):
   - outbound_calls: number | null
   - first_orders: number | null

2. Qualitative scoring fields (from new migration):
   - leadership: string | null
   - market_demand: string | null
   - marketing: string | null
   - product_strength: string | null
   - supplier_strength: string | null
   - sales_execution: string | null

Add these to both the Row type and Insert/Update types. In Row, they are nullable. In Insert/Update, they are optional.

Location: Find the company_submissions interface and add the new fields after the existing qualitative inputs section (company_biggest_opportunity, etc.).

Keep consistent with existing pattern - use snake_case for database field names.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass with no errors.
Grep for "outbound_calls" and "leadership" in database.types.ts - both should be present.
  </verify>
  <done>CompanySubmission type includes outbound_calls, first_orders, leadership, market_demand, marketing, product_strength, supplier_strength, sales_execution fields.</done>
</task>

<task type="auto">
  <name>Task 3: Create unified submission schema</name>
  <files>src/schemas/unified-submission.ts</files>
  <action>
Create a new Zod schema file that combines:
1. Month selection (FORM-06)
2. All fields from companySubmissionSchema (financial + commentary)
3. Lead KPI fields: outboundCalls (optional positive int), firstOrders (optional positive int)
4. Qualitative scoring fields: leadership, marketDemand, marketing, productStrength, supplierStrength, salesExecution

Reference scoring options from src/lib/scoring.ts for enum values.

```typescript
import { z } from 'zod'

const positiveMonetaryValue = z.coerce
  .number()
  .min(0, 'Must be a positive number')

const monetaryValue = z.coerce.number()

// Qualitative option enums (match src/lib/scoring.ts)
const leadershipOptions = z.enum(['aligned', 'minor', 'misaligned', 'toxic'])
const marketDemandOptions = z.enum(['strong', 'flat', 'softening', 'decline'])
const marketingOptions = z.enum(['clear', 'activity', 'poor', 'none'])
const productOptions = z.enum(['differentiated', 'adequate', 'weak', 'broken'])
const supplierOptions = z.enum(['strong', 'acceptable', 'weak', 'damaging'])
const salesOptions = z.enum(['beating', 'onTarget', 'underperforming', 'none'])

export const unifiedSubmissionSchema = z.object({
  // Month selection (FORM-06)
  month: z.string().regex(/^\d{4}-\d{2}$/, 'Select a month'),

  // Financial data (FORM-02)
  revenueActual: positiveMonetaryValue,
  revenueTarget: positiveMonetaryValue,
  grossProfitActual: monetaryValue,
  grossProfitTarget: monetaryValue,
  overheadsActual: positiveMonetaryValue,
  overheadsBudget: positiveMonetaryValue,
  netProfitActual: monetaryValue,
  netProfitTarget: monetaryValue,
  netProfitOverride: z.boolean().optional(),
  totalWages: positiveMonetaryValue,
  productivityBenchmark: z.coerce.number().min(0).max(20),

  // Lead KPIs (FORM-03) - optional
  outboundCalls: z.coerce.number().int().min(0).optional(),
  firstOrders: z.coerce.number().int().min(0).optional(),

  // Qualitative scoring (FORM-04)
  leadership: leadershipOptions,
  marketDemand: marketDemandOptions,
  marketing: marketingOptions,
  productStrength: productOptions,
  supplierStrength: supplierOptions,
  salesExecution: salesOptions,

  // Commentary (FORM-05) - optional
  companyWins: z.string().trim().optional(),
  companyChallenges: z.string().trim().optional(),
  companyBiggestOpportunity: z.string().trim().optional(),
  companyBiggestRisk: z.string().trim().optional(),
})

export type UnifiedSubmissionData = z.infer<typeof unifiedSubmissionSchema>
```

Note: Qualitative fields are REQUIRED in the unified form (not optional). This is different from the old consultant flow. Companies must self-assess.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
Import the schema in a test: `import { unifiedSubmissionSchema } from '@/schemas/unified-submission'`
  </verify>
  <done>Unified submission schema exported with all fields: month, financials, lead KPIs, qualitative scoring, commentary. Schema validates correctly.</done>
</task>

</tasks>

<verification>
1. Migration file exists with 6 qualitative columns
2. TypeScript types include all new fields (8 total: 2 Lead KPI + 6 qualitative)
3. Schema file exports unifiedSubmissionSchema and UnifiedSubmissionData type
4. `npx tsc --noEmit` passes
5. Schema can be imported without errors
</verification>

<success_criteria>
- Database migration adds leadership, market_demand, marketing, product_strength, supplier_strength, sales_execution to company_submissions
- TypeScript CompanySubmission type includes outbound_calls, first_orders, and all qualitative fields
- New unified-submission.ts schema validates: month, financials, lead KPIs, qualitative (required), commentary (optional)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-unified-form/03-01-SUMMARY.md`
</output>

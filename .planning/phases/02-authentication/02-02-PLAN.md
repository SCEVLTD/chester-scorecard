---
phase: 02-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/auth-context.tsx
  - src/components/auth/login-form.tsx
  - src/pages/login.tsx
autonomous: true
estimated_complexity: medium

must_haves:
  truths:
    - "AuthContext provides session, user, userRole, businessId to all components"
    - "Login form accepts email/password and calls Supabase signInWithPassword"
    - "Login page displays Chester/Velocity branding"
    - "Sign out clears session completely"
  artifacts:
    - path: "src/contexts/auth-context.tsx"
      provides: "Auth state management via React Context"
      exports: ["AuthProvider", "useAuth"]
    - path: "src/components/auth/login-form.tsx"
      provides: "Email/password login UI"
      min_lines: 40
    - path: "src/pages/login.tsx"
      provides: "Login page with branding"
      min_lines: 20
  key_links:
    - from: "src/contexts/auth-context.tsx"
      to: "@supabase/supabase-js"
      via: "supabase.auth methods"
      pattern: "supabase\\.auth\\.(getSession|signIn|signOut|onAuthStateChange)"
    - from: "src/components/auth/login-form.tsx"
      to: "src/contexts/auth-context.tsx"
      via: "useAuth hook"
      pattern: "useAuth\\(\\)"
---

<objective>
Create React authentication infrastructure: AuthContext for state management, login form component, and login page.

Purpose: Client-side auth handling with session persistence and role extraction from JWT.
Output: Reusable auth context and login UI components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md
@src/lib/supabase.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthContext provider</name>
  <files>src/contexts/auth-context.tsx</files>
  <action>
Create `src/contexts/auth-context.tsx` with:

1. **AuthContextType interface**:
```typescript
interface AuthContextType {
  session: Session | null
  user: User | null
  userRole: 'admin' | 'business_user' | null
  businessId: string | null
  isLoading: boolean
  signIn: (email: string, password: string) => Promise<{ error: Error | null }>
  signOut: () => Promise<void>
}
```

2. **AuthProvider component**:
- Initialize with `supabase.auth.getSession()` on mount
- Listen for auth changes with `supabase.auth.onAuthStateChange`
- Extract `user_role` and `business_id` from `session.user.app_metadata` (not user_metadata!)
- Provide `signIn` function using `supabase.auth.signInWithPassword`
- Provide `signOut` function using `supabase.auth.signOut`
- Clean up subscription on unmount

3. **useAuth hook**:
- Export hook that consumes AuthContext
- Throw error if used outside AuthProvider

Key implementation details:
- Import types from `@supabase/supabase-js`: `Session`, `User`
- Import supabase client from `@/lib/supabase`
- Set `isLoading: true` initially, `false` after getSession completes
- Claims are in `session?.user?.app_metadata` NOT `user_metadata`

Reference the exact code pattern from 02-RESEARCH.md "Pattern 1: AuthContext Provider" section.
  </action>
  <verify>
- File exports `AuthProvider` and `useAuth`
- TypeScript compiles: `npx tsc --noEmit src/contexts/auth-context.tsx`
- No eslint errors: `npx eslint src/contexts/auth-context.tsx`
  </verify>
  <done>
- AuthContext provides session, user, userRole, businessId, isLoading, signIn, signOut
- Claims extracted from app_metadata (secure, not user-modifiable)
- Subscription cleanup on unmount
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login form and page</name>
  <files>src/components/auth/login-form.tsx, src/pages/login.tsx</files>
  <action>
**Create `src/components/auth/login-form.tsx`:**

Login form with:
- Email input (type="email", required)
- Password input (type="password", required)
- Submit button with loading state
- Error handling with toast notification (sonner)
- On success: navigate to "/" (wouter useLocation)

Use existing UI components:
- `@/components/ui/input` for inputs
- `@/components/ui/button` for submit
- `@/components/ui/card` for form container

Key implementation:
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault()
  setIsLoading(true)
  const { error } = await signIn(email, password)
  if (error) {
    toast.error('Invalid email or password')
  } else {
    navigate('/')
  }
  setIsLoading(false)
}
```

**Create `src/pages/login.tsx`:**

Simple page that:
- Centers the login form vertically and horizontally
- Shows Velocity logo above the form (use existing logo from branding phase)
- Shows "Chester Business Scorecard" title
- Optionally shows "Doing good by doing well" strapline

Layout:
```typescript
<div className="min-h-screen flex items-center justify-center bg-gray-50">
  <LoginForm />
</div>
```

The LoginForm component should include the logo/branding in its Card header.
  </action>
  <verify>
- Both files compile: `npx tsc --noEmit`
- Login form has email, password, submit button
- Form uses useAuth() hook for signIn
- Page centers the form
  </verify>
  <done>
- LoginForm component handles email/password submission
- LoginPage displays form with Chester/Velocity branding
- Error states handled with toast notifications
- Loading state on submit button
  </done>
</task>

</tasks>

<verification>
1. `src/contexts/auth-context.tsx` exports AuthProvider and useAuth
2. `src/components/auth/login-form.tsx` exports LoginForm
3. `src/pages/login.tsx` exports LoginPage
4. All files pass TypeScript compilation
5. No missing imports or dependencies
</verification>

<success_criteria>
- AUTH-01 foundation: Login form UI ready for email/password auth
- AUTH-05 foundation: AuthContext subscribes to auth state changes for session persistence
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>

---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260202_add_auth_schema.sql
autonomous: true
estimated_complexity: medium

must_haves:
  truths:
    - "Profiles table exists linking auth.users to businesses"
    - "New user signup creates a profile record automatically"
    - "Auth hook adds role and business_id to JWT claims"
    - "Helper functions auth.business_id() and auth.is_admin() work in RLS policies"
  artifacts:
    - path: "supabase/migrations/20260202_add_auth_schema.sql"
      provides: "Authentication database schema"
      contains: "CREATE TABLE public.profiles"
  key_links:
    - from: "auth.users"
      to: "public.profiles"
      via: "trigger on_auth_user_created"
      pattern: "AFTER INSERT ON auth.users"
    - from: "public.profiles"
      to: "JWT claims"
      via: "custom_access_token_hook"
      pattern: "custom_access_token_hook"
---

<objective>
Create the database schema for authentication: profiles table, auth hook for JWT claims, and helper functions for RLS policies.

Purpose: Foundation for multi-tenant auth - users linked to businesses with role-based access.
Output: SQL migration file that sets up all auth infrastructure in Supabase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md
@supabase/migrations/00000000_full_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth schema migration</name>
  <files>supabase/migrations/20260202_add_auth_schema.sql</files>
  <action>
Create a new SQL migration file with the following components in order:

1. **Profiles table** - Links auth.users to businesses:
```sql
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  business_id UUID REFERENCES businesses(id) ON DELETE SET NULL,
  role TEXT NOT NULL DEFAULT 'business_user' CHECK (role IN ('admin', 'business_user')),
  full_name TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
```

2. **Trigger for auto-creating profile on signup**:
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name)
  VALUES (NEW.id, NEW.raw_user_meta_data->>'full_name');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

3. **Auth hook for custom JWT claims** (adds role and business_id to token):
```sql
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event JSONB)
RETURNS JSONB LANGUAGE plpgsql STABLE AS $$
DECLARE
  claims JSONB;
  user_role TEXT;
  user_business_id UUID;
BEGIN
  SELECT role, business_id INTO user_role, user_business_id
  FROM public.profiles
  WHERE id = (event->>'user_id')::UUID;

  claims := event->'claims';

  IF user_role IS NOT NULL THEN
    claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
  ELSE
    claims := jsonb_set(claims, '{user_role}', '"business_user"');
  END IF;

  IF user_business_id IS NOT NULL THEN
    claims := jsonb_set(claims, '{business_id}', to_jsonb(user_business_id));
  END IF;

  event := jsonb_set(event, '{claims}', claims);
  RETURN event;
END;
$$;

GRANT EXECUTE ON FUNCTION public.custom_access_token_hook TO supabase_auth_admin;
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM authenticated, anon, public;
```

4. **Helper functions for RLS policies**:
```sql
CREATE OR REPLACE FUNCTION auth.business_id()
RETURNS UUID AS $$
  SELECT NULLIF(
    current_setting('request.jwt.claims', true)::jsonb->>'business_id',
    ''
  )::UUID
$$ LANGUAGE sql STABLE;

CREATE OR REPLACE FUNCTION auth.is_admin()
RETURNS BOOLEAN AS $$
  SELECT COALESCE(
    current_setting('request.jwt.claims', true)::jsonb->>'user_role' = 'admin',
    false
  )
$$ LANGUAGE sql STABLE;
```

5. **Basic RLS policy for profiles** (users see own, admins see all):
```sql
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT USING (auth.uid() = id OR auth.is_admin());
CREATE POLICY "Users can update own profile" ON profiles
  FOR UPDATE USING (auth.uid() = id);
```
  </action>
  <verify>
Run: `npx supabase db push --dry-run` to validate SQL syntax (if Supabase CLI available)
Or: Open Supabase Dashboard > SQL Editor and paste migration to check for syntax errors
  </verify>
  <done>
Migration file exists with all 5 components: profiles table, user trigger, auth hook, helper functions, profiles RLS policies
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Enable Auth Hook in Supabase Dashboard</action>
  <why>Auth Hooks require manual Dashboard configuration - cannot be enabled via SQL migration</why>
  <instructions>
1. Go to Supabase Dashboard for the Chester project
2. Navigate to: Authentication > Hooks (may be in Settings > Auth)
3. Find "Custom Access Token" hook section
4. Select the function: `custom_access_token_hook`
5. Enable the hook
6. Save changes

Note: After enabling, new logins will include `user_role` and `business_id` in the JWT.
  </instructions>
  <resume-signal>Type "hook enabled" when complete</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Run migration and seed admin user</name>
  <files>supabase/migrations/20260202_add_auth_schema.sql</files>
  <action>
1. Apply the migration to the database:
   - Use Supabase CLI: `npx supabase db push`
   - Or: Run migration via Supabase Dashboard SQL Editor

2. Create admin user(s) for Chester:
   - Go to Supabase Dashboard > Authentication > Users
   - Click "Add user"
   - Create user with email: `admin@chester.org` (or Shane's actual email)
   - Set a temporary password

3. After user is created, update their profile to admin role:
```sql
-- Find the user and make them admin
UPDATE public.profiles
SET role = 'admin'
WHERE id = (SELECT id FROM auth.users WHERE email = 'admin@chester.org');
```

Note: The trigger will auto-create their profile row, we just need to update the role.
  </action>
  <verify>
Run in Supabase SQL Editor:
```sql
SELECT p.id, p.role, p.business_id, u.email
FROM profiles p
JOIN auth.users u ON p.id = u.id;
```
Should show the admin user with role='admin'.
  </verify>
  <done>
- profiles table exists
- Admin user created with role='admin'
- Trigger verified (profile auto-created on signup)
  </done>
</task>

</tasks>

<verification>
1. Query `profiles` table - should exist and have correct schema
2. Auth helper functions work:
```sql
SELECT auth.is_admin();  -- Should return false when not logged in
SELECT auth.business_id();  -- Should return null when not logged in
```
3. New user signup creates profile record automatically
4. Admin user has role='admin' in profiles table
</verification>

<success_criteria>
- AUTH-02 foundation: profiles table links users to businesses
- AUTH-03 foundation: role column distinguishes admin vs business_user
- AUTH-05 foundation: JWT claims include role and business_id for session persistence
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>

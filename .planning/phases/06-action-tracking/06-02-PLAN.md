---
phase: 06-action-tracking
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/add-action-modal.tsx
  - src/components/pending-actions-list.tsx
  - src/components/pending-actions-badge.tsx
  - src/pages/business.tsx
  - src/pages/portfolio.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can open modal and create action with description, owner, due date"
    - "Business page shows pending actions list with complete button"
    - "Portfolio dashboard shows pending action count badge"
    - "Completing action removes it from list immediately"
  artifacts:
    - path: "src/components/add-action-modal.tsx"
      provides: "Dialog form for creating actions"
      contains: "useCreateAction"
    - path: "src/components/pending-actions-list.tsx"
      provides: "List of actions with complete button"
      contains: "useCompleteAction"
    - path: "src/components/pending-actions-badge.tsx"
      provides: "Count badge for dashboard"
      contains: "usePendingActionsCount"
    - path: "src/pages/business.tsx"
      provides: "Business page with action components"
      contains: "AddActionModal"
    - path: "src/pages/portfolio.tsx"
      provides: "Dashboard with action badge"
      contains: "PendingActionsBadge"
  key_links:
    - from: "src/components/add-action-modal.tsx"
      to: "src/hooks/use-actions.ts"
      via: "useCreateAction mutation"
      pattern: "useCreateAction"
    - from: "src/components/pending-actions-list.tsx"
      to: "src/hooks/use-actions.ts"
      via: "useBusinessPendingActions + useCompleteAction"
      pattern: "useCompleteAction"
    - from: "src/pages/business.tsx"
      to: "src/components/add-action-modal.tsx"
      via: "Modal state and render"
      pattern: "AddActionModal"
---

<objective>
Create UI components for action tracking and integrate them into business and portfolio pages.

Purpose: Allow Chester admins to capture actions during Friday meetings and track completion.
Output: Working action creation modal, pending actions list, and dashboard badge.
</objective>

<execution_context>
@C:\Users\conta\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\conta\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-action-tracking/06-RESEARCH.md
@.planning/phases/06-action-tracking/06-01-SUMMARY.md

# Existing patterns to follow
@src/components/request-data-modal.tsx
@src/hooks/use-actions.ts
@src/pages/business.tsx
@src/pages/portfolio.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddActionModal component</name>
  <files>src/components/add-action-modal.tsx</files>
  <action>
Create src/components/add-action-modal.tsx following the pattern from request-data-modal.tsx:

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { toast } from 'sonner'
import { Loader2 } from 'lucide-react'
import { useCreateAction } from '@/hooks/use-actions'
import { actionSchema, type ActionFormData } from '@/schemas/action'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'

interface AddActionModalProps {
  businessId: string
  businessName: string
  open: boolean
  onOpenChange: (open: boolean) => void
}

export function AddActionModal({
  businessId,
  businessName,
  open,
  onOpenChange,
}: AddActionModalProps) {
  const createAction = useCreateAction()

  // Default due date to 7 days from now
  const defaultDueDate = new Date()
  defaultDueDate.setDate(defaultDueDate.getDate() + 7)

  const form = useForm<ActionFormData>({
    resolver: zodResolver(actionSchema),
    defaultValues: {
      description: '',
      owner: '',
      due_date: defaultDueDate.toISOString().split('T')[0],
    },
  })

  const onSubmit = async (data: ActionFormData) => {
    try {
      await createAction.mutateAsync({
        business_id: businessId,
        ...data,
      })
      toast.success('Action created successfully')
      handleClose()
    } catch (error) {
      console.error('Failed to create action:', error)
      toast.error('Failed to create action')
    }
  }

  const handleClose = () => {
    form.reset()
    onOpenChange(false)
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Add Action Item</DialogTitle>
          <DialogDescription>
            Create an action item for {businessName} from the Friday meeting.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <label className="text-sm font-medium">Action Description</label>
            <Textarea
              placeholder="e.g., Review Q1 forecast with finance team"
              rows={3}
              {...form.register('description')}
            />
            {form.formState.errors.description && (
              <p className="text-sm text-red-500">
                {form.formState.errors.description.message}
              </p>
            )}
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium">Owner</label>
            <Input
              placeholder="Person responsible for this action"
              {...form.register('owner')}
            />
            {form.formState.errors.owner && (
              <p className="text-sm text-red-500">
                {form.formState.errors.owner.message}
              </p>
            )}
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium">Due Date</label>
            <Input
              type="date"
              {...form.register('due_date')}
            />
            {form.formState.errors.due_date && (
              <p className="text-sm text-red-500">
                {form.formState.errors.due_date.message}
              </p>
            )}
          </div>

          <div className="flex justify-end gap-2 pt-2">
            <Button type="button" variant="outline" onClick={handleClose}>
              Cancel
            </Button>
            <Button type="submit" disabled={createAction.isPending}>
              {createAction.isPending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Creating...
                </>
              ) : (
                'Create Action'
              )}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

Key patterns:
- Form reset on close (prevents stale data)
- Loading state on submit button
- Validation errors displayed inline
- Default due date 7 days out
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Modal component ready for integration</done>
</task>

<task type="auto">
  <name>Task 2: Create PendingActionsList and PendingActionsBadge components</name>
  <files>src/components/pending-actions-list.tsx, src/components/pending-actions-badge.tsx</files>
  <action>
1. Create src/components/pending-actions-list.tsx:

```typescript
import { format, isPast, isToday } from 'date-fns'
import { Check, Clock, AlertCircle } from 'lucide-react'
import { toast } from 'sonner'
import { useBusinessPendingActions, useCompleteAction } from '@/hooks/use-actions'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'

interface PendingActionsListProps {
  businessId: string
}

export function PendingActionsList({ businessId }: PendingActionsListProps) {
  const { data: actions, isLoading } = useBusinessPendingActions(businessId)
  const completeAction = useCompleteAction()

  const handleComplete = async (actionId: string) => {
    try {
      await completeAction.mutateAsync(actionId)
      toast.success('Action marked as complete')
    } catch (error) {
      console.error('Failed to complete action:', error)
      toast.error('Failed to complete action')
    }
  }

  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Pending Actions</CardTitle>
        </CardHeader>
        <CardContent>
          <Skeleton className="h-16 w-full" />
        </CardContent>
      </Card>
    )
  }

  if (!actions || actions.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Pending Actions</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground">No pending actions</p>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">Pending Actions ({actions.length})</CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        {actions.map((action) => {
          const dueDate = new Date(action.due_date)
          const isOverdue = isPast(dueDate) && !isToday(dueDate)
          const isDueToday = isToday(dueDate)

          return (
            <div
              key={action.id}
              className="flex items-start gap-3 p-3 rounded-lg border bg-card"
            >
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium">{action.description}</p>
                <div className="flex items-center gap-3 mt-1 text-xs text-muted-foreground">
                  <span>Owner: {action.owner}</span>
                  <span className={`flex items-center gap-1 ${isOverdue ? 'text-red-500' : isDueToday ? 'text-amber-500' : ''}`}>
                    {isOverdue ? (
                      <AlertCircle className="h-3 w-3" />
                    ) : (
                      <Clock className="h-3 w-3" />
                    )}
                    Due: {format(dueDate, 'MMM d, yyyy')}
                    {isOverdue && ' (overdue)'}
                    {isDueToday && ' (today)'}
                  </span>
                </div>
              </div>
              <Button
                size="sm"
                variant="outline"
                onClick={() => handleComplete(action.id)}
                disabled={completeAction.isPending}
              >
                <Check className="h-4 w-4 mr-1" />
                Done
              </Button>
            </div>
          )
        })}
      </CardContent>
    </Card>
  )
}
```

2. Create src/components/pending-actions-badge.tsx:

```typescript
import { usePendingActionsCount } from '@/hooks/use-actions'
import { Badge } from '@/components/ui/badge'
import { Skeleton } from '@/components/ui/skeleton'

interface PendingActionsBadgeProps {
  businessId?: string
}

export function PendingActionsBadge({ businessId }: PendingActionsBadgeProps) {
  const { data: count, isLoading } = usePendingActionsCount(businessId)

  if (isLoading) {
    return <Skeleton className="h-5 w-8 rounded-full" />
  }

  if (!count || count === 0) {
    return null
  }

  return (
    <Badge variant="secondary" className="ml-2">
      {count} action{count !== 1 ? 's' : ''}
    </Badge>
  )
}
```

Key patterns:
- Overdue date highlighting (red for past, amber for today)
- Loading skeletons for better UX
- Badge hides when count is 0
- Complete button disables during mutation
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Action list and badge components ready for page integration</done>
</task>

<task type="auto">
  <name>Task 3: Integrate action components into pages</name>
  <files>src/pages/business.tsx, src/pages/portfolio.tsx</files>
  <action>
1. Update src/pages/business.tsx to add action modal and list:

Add imports at top:
```typescript
import { useState } from 'react'
import { Plus } from 'lucide-react'
import { AddActionModal } from '@/components/add-action-modal'
import { PendingActionsList } from '@/components/pending-actions-list'
```

Add state for modal:
```typescript
const [actionModalOpen, setActionModalOpen] = useState(false)
```

In the header card (after the Charts/History buttons div), add an "Add Action" button:
```typescript
<Button onClick={() => setActionModalOpen(true)}>
  <Plus className="mr-2 h-4 w-4" />
  Add Action
</Button>
```

After the BusinessScorecardView component, add:
```typescript
{/* Pending Actions */}
<div className="mt-6">
  <PendingActionsList businessId={businessId!} />
</div>

{/* Add Action Modal */}
<AddActionModal
  businessId={businessId!}
  businessName={business?.name || 'Unknown Business'}
  open={actionModalOpen}
  onOpenChange={setActionModalOpen}
/>
```

2. Update src/pages/portfolio.tsx to show action badge:

Add import:
```typescript
import { PendingActionsBadge } from '@/components/pending-actions-badge'
```

Find where businesses are rendered (likely in a card or list). For each business card/row, add the badge next to the business name or in a stats area:
```typescript
<PendingActionsBadge businessId={business.id} />
```

Also add a global pending actions count in the portfolio header (without businessId to get total):
```typescript
<PendingActionsBadge />
```

The exact placement depends on existing portfolio.tsx structure. Look for where business names are displayed and add badge there.
  </action>
  <verify>
1. App builds without errors: `npm run build`
2. Navigate to /business/:id/view/:scorecardId - Add Action button visible
3. Click Add Action - modal opens with form
  </verify>
  <done>Action tracking integrated into business and portfolio views</done>
</task>

</tasks>

<verification>
1. All component files exist with expected exports
2. `npm run build` succeeds
3. Manual testing:
   - Navigate to a business page (/business/:id/view/:scorecardId)
   - "Add Action" button appears in header
   - Click opens modal with description, owner, due date fields
   - Create action - toast shows success, modal closes
   - Action appears in Pending Actions list below scorecard
   - Click "Done" on action - toast shows success, action disappears
   - Portfolio dashboard shows pending action badges
</verification>

<success_criteria>
- Admin can add action with description, owner, due date from business page
- Action linked to specific business (business_id in database)
- Business page shows pending actions list with complete button
- Portfolio shows pending action count badge per business
- Completing action removes from pending list (cache invalidation works)
- All components follow existing UI patterns (shadcn/ui, Tailwind)
</success_criteria>

<output>
After completion, create `.planning/phases/06-action-tracking/06-02-SUMMARY.md`
</output>
